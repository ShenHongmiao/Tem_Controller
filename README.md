# STM32温度控制程序

基于STM32F103和FreeRTOS的精密温度控制系统

## 系统概述
本系统采用STM32F103微控制器和FreeRTOS实时操作系统，实现高精度的温度检测与PID控制。系统支持NTC热敏电阻温度检测、PID算法控制加热器输出，并提供串口通信功能向上位机实时发送温度数据。

## 版本信息
- **当前版本**: v1.5
- **更新内容**: 增加PA3按键中断切换PID设定温度功能
- **系统状态**: 稳定运行，支持双温度设定点切换控制


## 系统架构

### 硬件平台
- **MCU**: STM32F103xB (Cortex-M3, 64KB Flash, 20KB RAM)
- **RTOS**: FreeRTOS v10.3.1（CMSIS V1封装）
- **温度传感器**: NTC热敏电阻 (10KΩ@25℃, B=3380K)（SDNT1608X103F3380FTF 立创商城编号C316397）
- **控制输出**: 推挽输出控制加热器

### 任务架构
系统采用多任务并发设计，包含以下任务：

1. **TemperatureTask** (普通优先级)
   - 周期：500ms
   - 功能：ADC采集、温度计算
   - 堆栈：256字节

2. **ControlTask** (高优先级)
   - 周期：100ms
   - 功能：PID控制、输出控制
   - 堆栈：256字节

3. **UartSendTask** (低优先级)
   - 周期：2000ms (2秒)
   - 功能：通过串口发送温度数据到上位机
   - 堆栈：256字节

4. **DefaultTask** (普通优先级)
   - 周期：500ms
   - 功能：系统监控、心跳指示
   - 堆栈：128字节

## GPIO设置

| 引脚 | 功能描述 | 配置模式 | 说明 |
|------|---------|----------|------|
| PA0  | ADC1_IN0 | 模拟输入 (Analog Mode) | NTC热敏电阻信号采集 |
| PA3  | MODE_SWITCH | EXTI上升沿触发中断 (Pull-down) | PID模式切换按键 |
| PB0  | Control_1 | 推挽输出 (Push-Pull Output) | 加热器控制信号 (1=加热, 0=停止) |
| PA9  | USART1_TX | 复用推挽输出 (Alternate Function Push-Pull) | 串口发送引脚 |
| PA10 | USART1_RX | 浮空输入 (Floating Input) | 串口接收引脚 |
| PA13 | SWDIO | 调试接口 | SWD调试数据线 |
| PA14 | SWCLK | 调试接口 | SWD调试时钟线 |

![引脚设置](引脚设置.png)

**引脚说明：**
- PA0: 连接NTC热敏电阻分压电路，用于温度检测
- PB0: 输出控制信号，驱动加热器开关
- PA9/PA10: USART1串口通信引脚，用于向上位机发送温度数据  
  - PA9 (TX) → 连接到串口转USB模块的 RX 引脚
  - PA10 (RX) → 连接到串口转USB模块的 TX 引脚


## ADC设置 (ADC Configuration)

### ADC1配置参数
- **模式**: 独立模式 (Independent Mode)
- **转换模式**: 常规转换 (Regular Conversion)（非连续）
- **触发源**: 软件触发 (Software Start)
- **数据对齐**: 右对齐 (Right Alignment)
- **分辨率**: 12位 (0-4095)
- **参考电压**: 5.0V
- **采样时间**: 1.5个时钟周期

### 转换通道
- **通道**: ADC1_IN0 (PA0)
- **排序**: Rank 1
- **连续转换**: 禁用 (由软件控制)

## 模拟看门狗 (Analog Watchdog)
- **看门狗模式**: 单通道常规模式 (Single Regular Mode)
- **监控通道**: ADC1_IN0
- **中断模式**: 禁用
- **阈值设置**: 
  - 高阈值: 0 (未使用)
  - 低阈值: 0 (未使用)

## 温度检测系统

### NTC热敏电阻参数(TemCal.h)
```c
#define NTC_R25         10000.0     // 25℃标称电阻值 (10kΩ)
#define NTC_BETA        3977.0      // B参数 (3977K)
#define NTC_T25         298.15      // 25℃开尔文温度
#define PULL_UP_RES     10000.0     // 上拉电阻 (10kΩ)
#define ADC_VREF_VOLT   5.0         // ADC参考电压 (5V)
#define ADC_MAX_VALUE   4095.0      // 12位ADC最大值
```

### 温度计算算法
系统使用B参数方程计算温度：

```
1/T = 1/T25 + (1/Beta) * ln(R_T / R25)
```

其中：
- T: 开尔文温度 (K)
- T25: 25℃时的绝对温度 (298.15K)
- R_T: 当前温度下的电阻值
- R25: 25℃时的标称电阻值
- Beta: B参数

## PID模式切换功能

### 硬件配置
- **切换引脚**: PA3 (MODE_SWITCH_Pin)
- **中断类型**: EXTI3 上升沿触发
- **内部下拉**: 启用下拉电阻
- **STM32F103C8T6封装**: 48脚，PA3对应第13脚

### 双温度设定点（可通过宏定义修改）
```c
#define TEMP_SET_POINT_1        25.0f   // 温度设定点1 (摄氏度)
#define TEMP_SET_POINT_2        60.0f   // 温度设定点2 (摄氏度)
```

### 功能特性
- **模式切换**: PA3上升沿触发时自动在两个温度设定点间切换
- **PID重置**: 模式切换时自动重置PID控制器状态，避免积分饱和
- **串口提示**: 切换时通过串口发送确认信息
- **全局标志**: 使用`PID_Mode_Flag`变量标识当前模式 (0=模式1, 1=模式2)

### 硬件连接方式
**⚠️ 重要安全提醒**：
- **推荐方式**: 使用3.3V信号源
- **5V连接**: 如需使用5V信号，必须添加电阻分压保护
  ```
  5V ──[10kΩ]── PA3 ──[10kΩ]── GND
  ```
- **原因**: STM32F103 GPIO输入电压不能超过VDD+0.3V，直接5V输入会损坏芯片

### 中断处理
- **中断优先级**: 5 (较低优先级，不影响实时控制)
- **防抖处理**: 硬件中断处理，软件层面模式切换
- **线程安全**: 使用volatile修饰的全局变量

## PID温度控制系统

### PID参数配置（freertos.c）
```c
#define TEMP_SET_POINT_1        25.0f   // 温度设定点1 (℃)
#define TEMP_SET_POINT_2        60.0f   // 温度设定点2 (℃)
#define PID_KP          2.0f        // 比例系数
#define PID_KI          0.01f       // 积分系数
#define PID_KD          0.0f        // 微分系数
#define PID_MAX_OUTPUT  100.0f      // 输出上限 (%)
#define PID_MIN_OUTPUT  0.0f        // 输出下限 (%)
#define PID_MAX_INTEGRAL 50.0f      // 积分限幅
```

### 控制算法
- **比例项 (P)**: 响应当前温度误差，提供快速响应
- **积分项 (I)**: 累积历史误差，消除稳态偏差
- **微分项 (D)**: 预测温度变化趋势，提供系统阻尼

### 控制模式
系统支持两种控制模式：

#### 1. 继电器控制模式 (CONTROL_MODE_RELAY)
- PID输出 > 50%: 开启加热器 (PB0 = 1)
- PID输出 ≤ 50%: 关闭加热器 (PB0 = 0)

#### 2. PWM控制模式 (CONTROL_MODE_PWM)
- PWM频率: 1000Hz
- PWM周期: 1000ms
- 占空比: 0-100% (根据PID输出调节)

当前配置使用继电器控制模式。

## FreeRTOS配置

### 系统配置
- **调度器**: 抢占式调度
- **时钟频率**: 16MHz (外部晶振)
- **系统时钟**: 1ms (1000Hz)
- **内存管理**: heap_4.c
- **总堆大小**: 8KB

### 任务优先级
```c
osPriorityLow       = 1     // 串口发送任务
osPriorityNormal    = 2     // 温度读取任务、默认任务
osPriorityHigh      = 3     // 控制任务
```

### 同步机制
- **全局变量**: `g_temperature` (当前温度值)
- **控制标志**: `g_control_flag` (加热器状态)
- **任务同步**: 通过延时实现时序控制

## 系统性能指标

### 控制精度
- **稳态精度**: ±0.5℃
- **超调量**: < 2℃
- **调节时间**: < 30秒

### 响应特性
- **ADC采样频率**: 2Hz (500ms周期)
- **控制更新频率**: 10Hz (100ms周期)
- **串口发送频率**: 0.5Hz (2000ms周期)
- **温度分辨率**: 0.1℃

### 资源占用
- **Flash使用**: ~14KB (21.9%)
- **RAM使用**: ~6KB (30.1%)
- **CPU占用**: < 5%

## 编译与构建

### 环境要求
- STM32CubeIDE 或 CLion + STM32CubeCLT
- ARM GCC Toolchain
- CMake 3.22+

### 编译命令
```bash
cd build/Debug
cmake --build .
```

## 调试与监控

### 全局变量监控
- `g_temperature`: 实时温度值 (℃)
- `g_control_flag`: 加热器状态 (0/1)
- `PID_Mode_Flag`: PID模式标志 (0=模式1, 1=模式2)
- `temp_pid.setpoint`: 当前PID设定点 (℃)
- `temp_pid.output`: PID输出值 (%)
- `temp_pid.integral`: 积分累积值

### 调试接口
- **SWD接口**: PA13 (SWDIO), PA14 (SWCLK)
- **调试器**: ST-Link v2/v3
- **实时监控**: Live Expressions, Memory Monitor

## 使用说明

1. **硬件连接**:
   - 将NTC热敏电阻连接到PA0
   - 将加热器控制端连接到PB0
   - 连接串口到PA9(TX)/PA10(RX)
   - 连接模式切换信号到PA3 (⚠️注意电压保护)
   - 确保电源和地线正确连接

2. **参数调整**:
   - 修改 `TEMP_SET_POINT_1` 和 `TEMP_SET_POINT_2` 设置两个目标温度
   - 调整PID参数优化控制效果
   - 根据实际硬件调整NTC参数

3. **系统启动**:
   - 上电后系统自动初始化，默认为模式1
   - 1秒后开始温度采集
   - 1.5秒后开始PID控制
   - 2秒后开始串口通信

4. **模式切换**:
   - PA3引脚接收上升沿信号即可切换PID模式
   - 切换时PID控制器自动重置避免积分饱和
   - 通过串口可监控当前模式和目标温度

## 故障排除

### 常见问题
1. **温度读数异常**: 检查ADC接线和NTC参数
2. **控制不稳定**: 调整PID参数，特别是Kp和Kd
3. **系统无响应**: 检查FreeRTOS配置和堆栈大小
4. **串口无输出**: 检查波特率设置和接线
5. **按键无响应**: 检查PA3接线和电压电平，确认中断配置
6. **芯片损坏**: 检查PA3是否误接5V而无电压保护

### 参数调优建议
- **Kp过大**: 系统振荡，减小Kp值
- **Ki过大**: 系统不稳定，减小Ki值  
- **Kd过大**: 对噪声敏感，减小Kd值

### PA3接线安全指南
- **3.3V信号**: 直接连接，最安全
- **5V信号**: 必须添加电阻分压 (10kΩ-10kΩ)
- **机械按键**: 一端接3.3V，另一端接PA3，利用内部下拉
- **数字信号**: 确保高电平不超过3.6V


## 串口通信

### USART1配置参数(usart.c)
- **波特率**: 9600 bps
- **数据位**: 8位
- **停止位**: 1位
- **校验位**: 无
- **流控制**: 无
- **模式**: 发送+接收 (TX+RX)

### 数据格式

#### 1. 系统启动消息
系统启动时自动发送一次启动信息：
```
Temperature Control System Started
PA3 button: Switch PID target temperature
Mode 1 Target: 25.0 C, Mode 2 Target: 60.0 C
==================================
```

#### 2. 定时温度数据
系统通过串口每2秒自动发送一次当前温度、目标温度和模式信息：
```
Temp: xx.x C, Target: xx.x C, Mode: x
```

#### 3. 模式切换消息
PA3按键触发时发送模式切换确认：
```
Mode switched to x, Target: xx.x C
```

**示例完整输出：**
```
Temperature Control System Started
PA3 button: Switch PID target temperature  
Mode 1 Target: 25.0 C, Mode 2 Target: 60.0 C
==================================
Temp: 24.3 C, Target: 25.0 C, Mode: 1
Temp: 24.8 C, Target: 25.0 C, Mode: 1
Mode switched to 2, Target: 60.0 C
Temp: 25.1 C, Target: 60.0 C, Mode: 2
Temp: 25.6 C, Target: 60.0 C, Mode: 2
```

### 串口任务特性
- **任务优先级**: 低优先级 (osPriorityLow)
- **发送周期**: 2000ms (2秒)
- **数据精度**: 保留1位小数
- **任务堆栈**: 256字节
- **任务名称**: UartSendTask

**注意事项：**
- 串口发送任务具有最低优先级，不会影响温度控制的实时性
- 温度数据来源于全局变量 `g_temperature`，与控制系统共享
- 使用阻塞发送模式确保数据完整性

## 版本历史

- **v1.0**: 基础温度检测功能
- **v1.1**: 增加FreeRTOS多任务架构
- **v1.2**: 实现PID温度控制算法
- **v1.3**: 优化控制参数和系统稳定性
- **v1.4**: 新增串口通信功能，支持实时向上位机发送温度数据，支持继电器和PWM两种控制模式
- **v1.5**: 新增PA3按键中断切换PID设定温度功能，支持双温度设定点，模式切换时自动重置PID状态

## 技术特点

### 1. 多任务架构
- 采用FreeRTOS实现任务分离，提高系统响应性
- 温度采集、控制算法、串口通信独立运行
- 优先级分配确保关键任务实时性

### 2. 高精度温度检测
- 12位ADC分辨率，温度检测精度0.1℃
- NTC热敏电阻B参数算法，宽温度范围检测
- 软件滤波减少噪声干扰

### 3. 智能PID控制
- 经典PID三项控制，响应快速、稳定性好
- 积分项限幅防止积分饱和
- 支持继电器和PWM两种输出模式

### 4. 实时数据通信
- 串口实时发送温度数据，便于监控调试
- 启动信息提示，系统状态清晰可见
- 低优先级设计，不影响控制性能

### 5. 系统可靠性
- 任务创建失败检测，确保系统正常启动
- 堆栈溢出检测，防止内存错误
- 看门狗机制（可选），提高系统稳定性

## 开发说明

### 源文件结构
```
Core/Src/
├── main.c              // 主程序入口，硬件初始化
├── freertos.c          // FreeRTOS任务定义，PID控制算法
├── adc.c               // ADC配置与读取
├── usart.c             // 串口配置与通信
├── gpio.c              // GPIO配置
├── TemCal.c            // 温度计算算法
└── stm32f1xx_it.c      // 中断服务程序

Core/Inc/
├── main.h              // 主程序头文件
├── FreeRTOSConfig.h    // FreeRTOS配置
├── adc.h               // ADC头文件
├── usart.h             // 串口头文件
├── gpio.h              // GPIO头文件
└── TemCal.h            // 温度计算头文件
```

### 编程风格
- 采用STM32 HAL库，代码可移植性好
- 函数命名清晰，注释详细
- 宏定义统一管理，便于参数调整
- 模块化设计，功能分离明确

### 扩展建议
1. **增加LCD显示**: 本地显示温度和控制状态
2. **网络通信**: 增加WiFi/以太网模块实现远程监控
3. **数据存储**: 添加Flash存储，记录温度历史数据
4. **多点检测**: 扩展多个温度传感器，实现多点控制
5. **安全保护**: 增加过温保护、断线检测等安全机制

本温度控制系统设计完善，功能齐全，可作为工业温控、实验设备、恒温箱等应用的控制核心。
